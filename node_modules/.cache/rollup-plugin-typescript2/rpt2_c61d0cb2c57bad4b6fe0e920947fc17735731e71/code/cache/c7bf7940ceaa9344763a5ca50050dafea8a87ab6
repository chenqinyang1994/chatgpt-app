{"code":"import { __awaiter, __generator, __spreadArray } from \"tslib\";\nimport React, { useState, useEffect, useRef } from \"react\";\nimport classNames from \"classnames\";\nimport message from 'antd-message-react';\nimport { uid } from \"uid\";\nimport { indexQuestionDetail, chatWS } from \"./services/index\";\nimport { authToken } from \"./utils/authService\";\nimport Chat from \"./components/chat\";\nimport sendImg from \"./assets/chat-images/send.png\";\nimport './index.less';\nexport default function Home() {\n    var _this = this;\n    var _a = useState([]), chatData = _a[0], setChatData = _a[1];\n    var _b = useState(\"\"), question = _b[0], setQuestion = _b[1];\n    var indexListDOM = useRef(null);\n    // scrollRefæ˜¯ä¸ªå¼€å…³ï¼Œç”¨äºæ§åˆ¶æ˜¯å¦æ»šåŠ¨åˆ°æœ€åº•éƒ¨ï¼Œé»˜è®¤å¼€å¯\n    var scrollRef = useRef(true);\n    // wsRefç”¨äºå­˜websocketçš„sendå‡½æ•°\n    var wsRef = useRef(null);\n    // answerRefç”¨äºå­˜websocketè¿”å›çš„ç­”æ¡ˆçš„æ•°ç»„ï¼Œå› ä¸ºè¿”å›é¡ºåºå¯èƒ½ä¹±ï¼Œç”¨indexå­—æ®µè¿›è¡Œæ’åº\n    var answerRef = useRef([]);\n    // ç”¨äºå­˜questionIdï¼Œåœ¨socketæ–­äº†ä¹‹åï¼Œç”¨è¿™ä¸ªidå»è¯·æ±‚httpæ¥å£ï¼Œå–é—®é¢˜çš„ç­”æ¡ˆè¦†ç›–åˆ°æ•°æ®é˜Ÿåˆ—é‡Œ\n    var questionIdRef = useRef(\"\");\n    // ç”¨äºå­˜websocketçš„å¿ƒè·³å®šæ—¶å™¨id\n    var timerRef = useRef(null);\n    // ç”¨äºå­˜opä¸ºstatusæ—¶çš„è¿”å›å€¼\n    var statusRef = useRef({});\n    // ç”¨äºå­˜æ¶ˆæ¯å‘é€ç­‰å¾…æœåŠ¡ç«¯è¿”å›çš„å®šæ—¶å™¨id\n    var waitTimerRef = useRef(null);\n    // ç”¨äºå­˜websocketå›ç­”è¿‡ç¨‹ä¸­çš„å®šæ—¶å™¨id\n    var answeringTimerRef = useRef(null);\n    // æ˜¯å¦è§¦å‘äº†å›ç­”ä¸­çš„å®šæ—¶å™¨\n    var answeringTimerIsShow = useRef(false);\n    // questionè¯¦æƒ…æ¥å£è½®è¯¢æ¬¡æ•°\n    var questionFetchCount = useRef(0);\n    // questionè¯¦æƒ…æ¥å£è½®è¯¢é—´éš”å®šæ—¶å™¨\n    var questionFetchTimerRef = useRef(null);\n    var costomConfig = {\n        waitTimer: 1000 * 5,\n        answeringTimer: 1000 * 3,\n        questionFetchCountMax: 10,\n        socketHeartbeat: 1000 * 30,\n        questionFetchTimer: 1000 * 3 // questionè¯¦æƒ…æ¥å£è½®è¯¢é—´éš” 3s\n    };\n    var domScrollFn = function () {\n        // æ»šåŠ¨åˆ°æœ€åº•éƒ¨å‡½æ•°\n        if (!scrollRef.current) {\n            // æ»šåŠ¨å¼€å…³\n            return;\n        }\n        if (indexListDOM.current) {\n            var dom = indexListDOM.current;\n            dom.scrollTop = dom.scrollHeight;\n        }\n    };\n    var handleSetData = function (data, op) {\n        if (op === \"question\") {\n            setChatData(function (cData) {\n                return __spreadArray(__spreadArray([], cData, true), [data], false);\n            });\n            return;\n        }\n        if (op === \"status\") {\n            var id_1 = data.id, isDone_1 = data.isDone, status_1 = data.status;\n            setChatData(function (cData) {\n                return cData.map(function (item) {\n                    if ((item === null || item === void 0 ? void 0 : item.id) === id_1) {\n                        item.isDone = isDone_1;\n                        item.status = status_1;\n                        return item;\n                    }\n                    return item;\n                });\n            });\n            return;\n        }\n        var id = data.id, answer = data.answer, isDone = data.isDone, status = data.status;\n        setChatData(function (cData) {\n            return cData.map(function (item) {\n                if ((item === null || item === void 0 ? void 0 : item.id) === id) {\n                    item.answer = answer;\n                    item.isDone = isDone;\n                    item.status = status;\n                    return item;\n                }\n                return item;\n            });\n        });\n    };\n    var onTextConfirm = function () {\n        if (!question) {\n            message.error('é—®é¢˜ä¸èƒ½ä¸ºç©º');\n            return;\n        }\n        if (!(question ? question.trim() : \"\")) {\n            message.error('é—®é¢˜ä¸èƒ½ä¸ºç©º');\n            return;\n        }\n        // æœªç™»å½•\n        if (!authToken.get()) {\n            message.error('å°šæœªç™»å½•');\n            return;\n        }\n        function onSubmit() {\n            // æ¸…ç©ºçŠ¶æ€å€¼\n            statusRef.current = {};\n            handleWsSend(question ? question.trim() : \"\");\n            setQuestion(\"\");\n        }\n        if (navigator.onLine) {\n            onSubmit();\n        }\n        else {\n            message.error('ç½‘ç»œæ— å“åº”ï¼Œå‘é€å¤±è´¥');\n        }\n    };\n    function handleWsSend(params) {\n        var _a, _b, _c;\n        if (wsRef.current) {\n            var id = uid();\n            var data = JSON.stringify({\n                op: \"question\",\n                webId: id,\n                token: authToken.get(),\n                question: params,\n            });\n            (_a = wsRef.current) === null || _a === void 0 ? void 0 : _a.send(data);\n            waitTimerRef.current = setTimeout(function () {\n                message.error('æœåŠ¡ç«¯æœªå“åº”ï¼Œè¯·åˆ·æ–°é‡è¯•');\n                clearTimeout(waitTimerRef.current);\n            }, costomConfig.waitTimer);\n            answeringTimerIsShow.current = false;\n            // æ–°å»ºä¸€ä¸ªé—®é¢˜ï¼Œæ­¤æ—¶åˆ›å»ºç­”æ¡ˆä¸ºç©ºçš„æ•°æ®\n            answerRef.current = [];\n            questionIdRef.current = id;\n            handleSetData({\n                id: id,\n                question: question,\n                answer: \"\",\n                timestamp: +new Date(),\n                isDone: (_b = statusRef.current) === null || _b === void 0 ? void 0 : _b.isDone,\n                status: (_c = statusRef.current) === null || _c === void 0 ? void 0 : _c.status,\n            }, \"question\");\n        }\n    }\n    var answeringTimerCallback = function () {\n        answeringTimerIsShow.current = true;\n        // å¦‚æœhttpè¿”å›çš„answeræœ‰å€¼ï¼Œå°±åˆ‡æ–­socketï¼ŒæŠŠhttpçš„è¿”å›å€¼ç›´æ¥è¦†ç›–åˆ°å¯¹åº”idçš„answerå­—æ®µä¸Š\n        message.error('answeringTimerCallback');\n        // ç”¨æ¥å¤„ç†socketæœ‰å›å¤ä½†æ˜¯å›å¤ä¸­æ–­çš„æƒ…å†µ\n        var id = questionIdRef.current;\n        if (!id) {\n            return;\n        }\n        questionFetchCount.current = 0;\n        var onQuestionFetch = function () { return __awaiter(_this, void 0, void 0, function () {\n            var res, answer;\n            var _a;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        questionFetchCount.current = questionFetchCount.current + 1;\n                        return [4 /*yield*/, indexQuestionDetail({ id: id })];\n                    case 1:\n                        res = _b.sent();\n                        if (res.code === 200) {\n                            answer = (_a = res === null || res === void 0 ? void 0 : res.data) === null || _a === void 0 ? void 0 : _a.answer;\n                            if (answer === null || answer === undefined) {\n                                console.log('questionFetchCount.current', questionFetchCount.current);\n                                if (questionFetchCount.current >= costomConfig.questionFetchCountMax) {\n                                    message.error(\"\\u95EE\\u9898\\u8BE6\\u60C5\\u63A5\\u53E3\\u8F6E\\u8BE2\".concat(costomConfig.questionFetchCountMax, \"\\u6B21\\u672A\\u67E5\\u8BE2\\u5230\\u6570\\u636E\"));\n                                    return [2 /*return*/];\n                                }\n                                // å¦‚ä½•answerä¸å­˜åœ¨ï¼Œè½®è¯¢indexQuestionDetailæ¥å£\n                                clearTimeout(questionFetchTimerRef.current);\n                                questionFetchTimerRef.current = setTimeout(function () {\n                                    onQuestionFetch();\n                                }, costomConfig.questionFetchTimer);\n                                return [2 /*return*/];\n                            }\n                            if (wsRef.current) {\n                                // å…³é—­socketé“¾æ¥ï¼Œç”¨httpè¯·æ±‚å›æ¥çš„ç­”æ¡ˆç›´æ¥è¦†ç›–åˆ°å¯¹åº”idä¸Š\n                                wsRef.current.close();\n                                console.log(\"ğŸš€ ~ file: index.tsx:184 ~ onQuestionFetch ~ close:\");\n                            }\n                            handleSetData({\n                                id: id,\n                                question: \"\",\n                                answer: answer,\n                                timestamp: 0,\n                            }, \"answer\");\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        }); };\n        onQuestionFetch();\n    };\n    function WsHandshake() {\n        // è¿æ¥socketï¼Œå¤„ç†socketè¿”å›çš„message\n        wsRef.current = chatWS({\n            successFn: function (res) {\n                var _a, _b;\n                var op = res.op, webId = res.webId, question = res.question, timestamp = res.timestamp, answer = res.answer, index = res.index, resMessage = res.message, isDone = res.isDone, status = res.status;\n                if (op === \"error\") {\n                    answerRef.current = [];\n                    if (+resMessage === 4201) {\n                        message.info('ä»Šæ—¥å…è´¹æ¬¡æ•°å·²ç”¨å®Œ');\n                        return;\n                    }\n                    //   wså…¶ä»–æŠ¥é”™\n                    message.error(resMessage);\n                    return;\n                }\n                if (op === \"status\") {\n                    // status: 1åˆ›å»ºæé—®æœªå¼€å§‹å›ç­” 2å›ç­”ä¸­ 3å›ç­”å®Œæˆ 4å›ç­”å¼‚å¸¸\n                    statusRef.current = {\n                        isDone: isDone,\n                        status: status,\n                    };\n                    if (status === 1) {\n                        // æœåŠ¡å·²å“åº”ï¼Œåˆ›å»ºæé—®æœªå¼€å§‹å›ç­”\n                        clearTimeout(waitTimerRef.current);\n                        return;\n                    }\n                    if (status === 2) {\n                        answeringTimerRef.current = setTimeout(answeringTimerCallback, costomConfig.answeringTimer);\n                        return;\n                    }\n                    if (status === 3 || status === 4) {\n                        if (!answeringTimerIsShow.current) {\n                            clearTimeout(answeringTimerRef.current);\n                        }\n                        statusRef.current = {};\n                        handleSetData({\n                            id: webId,\n                            isDone: isDone,\n                            status: status,\n                            question: \"\",\n                            answer: \"\",\n                            timestamp: 0,\n                        }, \"status\");\n                    }\n                    return;\n                }\n                if (op === \"answer\") {\n                    // wsè¿”å›æ˜¯ç­”æ¡ˆ\n                    answerRef.current[index] = answer;\n                    handleSetData({\n                        id: webId,\n                        question: question,\n                        answer: answerRef.current.filter(Boolean).join(\"\"),\n                        timestamp: timestamp,\n                        isDone: (_a = statusRef.current) === null || _a === void 0 ? void 0 : _a.isDone,\n                        status: (_b = statusRef.current) === null || _b === void 0 ? void 0 : _b.status,\n                    }, \"answer\");\n                    // å¦‚æœå®šæ—¶å™¨è¢«è§¦å‘äº†ï¼Œå°±ä¸å†æ‰§è¡Œæ¸…é™¤æˆ–è€…é‡ç½®æ“ä½œï¼Œç­‰å¾…å®šæ—¶å™¨å†…é€»è¾‘æ‰§è¡Œå®Œ\n                    if (!answeringTimerIsShow.current) {\n                        // æ¯æ¬¡answerè¿”å›æ—¶ï¼Œå…ˆæ¸…é™¤ä¸Šä¸€æ¬¡çš„answeringTimerRefï¼Œç„¶åæ–°å»ºä¸€ä¸ªansweringTimerRef\n                        clearTimeout(answeringTimerRef.current);\n                        answeringTimerRef.current = setTimeout(answeringTimerCallback, costomConfig.answeringTimer);\n                    }\n                    return;\n                }\n            },\n            errorFn: function (err) {\n            },\n        });\n        wsRef.current.addEventListener(\"open\", function () {\n            clearInterval(timerRef.current);\n            timerRef.current = setInterval(function () {\n                var _a;\n                (_a = wsRef.current) === null || _a === void 0 ? void 0 : _a.send(\"ping\");\n            }, costomConfig.socketHeartbeat);\n        });\n        wsRef.current.addEventListener(\"close\", function (closeEvent) {\n            return onWsCloseOrError(\"close\", closeEvent);\n        });\n        wsRef.current.addEventListener(\"error\", function (errorEvent) {\n            return onWsCloseOrError(\"error\", errorEvent);\n        });\n        return wsRef.current;\n    }\n    var onWsCloseOrError = function (t, e) {\n        // å½“websocketçŠ¶æ€æ˜¯ close æˆ– error çš„æ—¶å€™ï¼Œè§¦å‘æ­¤å‡½æ•°\n        console.log(\"ğŸš€ ~ file: index.tsx:303 ~ onWsCloseOrError ~ onWsCloseOrError:\");\n        wsRef.current && wsRef.current.reconnect();\n    };\n    function onOffline() {\n        message.error('ç½‘ç»œå·²æ–­å¼€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€', 3.5);\n    }\n    var componentDidMount = function () {\n        // é“¾æ¥websocket\n        WsHandshake();\n        setQuestion(\"\");\n        setChatData([\n            {\n                id: uid(),\n                question: \"Hello\",\n                answer: \"ä½ å¥½ï¼Œæˆ‘æ˜¯äººå·¥æ™ºèƒ½å¤§å¸ˆï¼Œä»€ä¹ˆé—®é¢˜éƒ½èƒ½å›ç­”ï¼Œå¿«æ¥å’Œæˆ‘èŠå¤©å§ï¼\",\n                timestamp: 1,\n            },\n        ]);\n        window.addEventListener('offline', onOffline);\n    };\n    var componentWillUnmount = function () {\n        if (timerRef.current) {\n            clearInterval(timerRef.current);\n        }\n        setChatData([]);\n        setQuestion(\"\");\n        window.removeEventListener('offline', onOffline);\n    };\n    useEffect(function () {\n        componentDidMount();\n        return componentWillUnmount;\n    }, []);\n    return (React.createElement(\"div\", { className: \"index\" },\n        React.createElement(\"div\", { className: \"index-list\", ref: indexListDOM }, chatData.map(function (chat, index) {\n            return (React.createElement(Chat, { key: chat.id + index, data: chat, domScrollFn: domScrollFn, onGetScrollSwicth: function () { return scrollRef.current; } }));\n        })),\n        React.createElement(\"div\", { className: \"input-bottom\" },\n            React.createElement(\"div\", { className: \"index-input-box\" },\n                React.createElement(\"input\", { placeholder: \"\\u8BD5\\u8BD5\\u6253\\u5B57\\u548C\\u6211\\u804A\\u5929\\u5427\", className: \"index-input\", value: question, onChange: function (e) {\n                        setQuestion(e.target.value);\n                    }, onKeyDown: function (e) {\n                        if (e.key === \"Enter\") {\n                            onTextConfirm();\n                        }\n                    } }),\n                React.createElement(\"div\", { className: classNames(\"index-input-right\", {\n                        active: !!question.length,\n                    }) },\n                    React.createElement(\"img\", { src: sendImg, className: \"index-send\", onClick: onTextConfirm }))))));\n}\n","references":["/Users/chenqinyang/Desktop/chat-requset-rollup/node_modules/@types/react/index.d.ts","/Users/chenqinyang/Desktop/chat-requset-rollup/node_modules/classnames/index.d.ts","/Users/chenqinyang/Desktop/chat-requset-rollup/node_modules/antd-message-react/dist/src/message/index.d.ts","/Users/chenqinyang/Desktop/chat-requset-rollup/src/services/index.ts","/Users/chenqinyang/Desktop/chat-requset-rollup/src/utils/authService.ts","/Users/chenqinyang/Desktop/chat-requset-rollup/src/components/chat/index.tsx"],"dts":{"name":"/Users/chenqinyang/Desktop/chat-requset-rollup/node_modules/.cache/rollup-plugin-typescript2/placeholder/index.d.ts","writeByteOrderMark":false,"text":"/// <reference types=\"react\" />\nimport './index.less';\nexport interface IItem {\n    id: string;\n    question: string;\n    answer: string;\n    timestamp: number;\n    isDone?: boolean;\n    status?: 1 | 2 | 3 | 4;\n}\nexport default function Home(): JSX.Element;\n"}}
